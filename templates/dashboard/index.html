<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚è∞ Sistema de Controle de Interjornada - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            min-height: 100vh;
            padding: 10px;
            color: #ffffff;
        }

        .container {
            background: rgba(29, 29, 29, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            padding: 30px;
            width: 100%;
            max-width: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(251, 72, 9, 0.2);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            flex: 0 0 auto;
        }

        .header-center {
            flex: 1;
            text-align: center;
        }

        .header-right {
            flex: 0 0 auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            height: 80px;
            filter: drop-shadow(0 4px 8px rgba(251, 72, 9, 0.3));
        }

        .title {
            color: #ffffff;
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.2em;
            font-weight: 400;
        }

        .status-indicator {
            text-align: right;
        }

        .status-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            display: block;
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 10px;
            color: #3498db;
        }

        .stat-label {
            font-size: 1.1em;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .section {
            background: rgba(44, 62, 80, 0.3);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .employee-card {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
            transition: transform 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .employee-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .employee-card.active {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .employee-card.active:hover {
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        }

        .employee-name {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .employee-id {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 10px;
        }

        .employee-time {
            font-size: 1.1em;
            font-weight: 500;
        }

        .employee-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-blocked {
            background: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }

        .status-active {
            background: rgba(39, 174, 96, 0.3);
            color: #27ae60;
        }

        .status-pending {
            background: rgba(241, 196, 15, 0.3);
            color: #f1c40f;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.6);
        }

        .error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            color: #e74c3c;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            margin: 5% auto;
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .modal-title {
            font-size: 2em;
            font-weight: 700;
            color: #e74c3c;
            margin-bottom: 10px;
        }

        .modal-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1em;
        }

        .modal-body {
            text-align: center;
        }

        .modal-employee-info {
            background: rgba(231, 76, 60, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .modal-employee-name {
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #e74c3c;
        }

        .modal-employee-id {
            font-size: 1.2em;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 15px;
        }

        .modal-time-info {
            font-size: 1.3em;
            font-weight: 500;
            margin: 10px 0;
        }

        .modal-close {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1em;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .audio-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(44, 62, 80, 0.9);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .audio-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .audio-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .audio-btn.muted {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .title {
                font-size: 2em;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <img src="/static/logo.png" alt="Logo" class="logo">
            </div>
            <div class="header-center">
                <h1 class="title">Sistema de Controle de Interjornada</h1>
                <p class="subtitle">Dashboard em Tempo Real</p>
            </div>
            <div class="header-right">
                <div class="status-indicator">
                    <div class="status-badge" id="connectionStatus">Conectando...</div>
                </div>
            </div>
        </div>

        <button class="refresh-btn" onclick="refreshData()">üîÑ Atualizar Dados</button>

        <div class="stats-grid" id="statsGrid">
            <div class="loading">Carregando estat√≠sticas...</div>
        </div>

        <div class="content-grid">
            <div class="section">
                <h2 class="section-title">üö´ Funcion√°rios Bloqueados</h2>
                <div id="blockedEmployees">
                    <div class="loading">Carregando funcion√°rios bloqueados...</div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">‚úÖ Funcion√°rios Ativos</h2>
                <div id="activeEmployees">
                    <div class="loading">Carregando funcion√°rios ativos...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Acesso Negado -->
    <div id="accessDeniedModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üö´ Acesso Negado</h2>
                <p class="modal-subtitle">Funcion√°rio em per√≠odo de interjornada</p>
            </div>
            <div class="modal-body">
                <div class="modal-employee-info" id="modalEmployeeInfo">
                    <!-- Conte√∫do ser√° preenchido dinamicamente -->
                </div>
                <button class="modal-close" onclick="closeModal()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes do Funcion√°rio -->
    <div id="employeeDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üë§ Detalhes do Funcion√°rio</h2>
                <p class="modal-subtitle">Informa√ß√µes da sess√£o ativa</p>
            </div>
            <div class="modal-body">
                <div class="modal-employee-info" id="employeeDetailsInfo">
                    <!-- Informa√ß√µes detalhadas ser√£o inseridas aqui -->
                </div>
                <button class="modal-close" onclick="closeEmployeeModal()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Controles de √Åudio -->
    <div class="audio-controls">
        <button class="audio-btn" id="audioBtn" onclick="toggleAudio()">üîä √Åudio</button>
    </div>

    <!-- √Åudio de Alerta -->
    <audio id="alertAudio" preload="auto">
        <source src="/static/audio/agurade.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Vari√°veis globais
        let websocket = null;
        let audioEnabled = true;
        let lastUpdateTime = null;
        let dashboardData = null;

        // Inicializar WebSocket
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/dashboard/`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function(event) {
                console.log('WebSocket conectado');
                updateConnectionStatus('Conectado', 'success');
            };
            
            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            websocket.onclose = function(event) {
                console.log('WebSocket desconectado');
                updateConnectionStatus('Desconectado', 'error');
                // Tentar reconectar ap√≥s 3 segundos
                setTimeout(initWebSocket, 3000);
            };
            
            websocket.onerror = function(error) {
                console.error('Erro no WebSocket:', error);
                updateConnectionStatus('Erro', 'error');
            };
        }

        // Atualizar status de conex√£o
        function updateConnectionStatus(status, type) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = status;
            statusElement.className = `status-badge ${type}`;
        }

        // Processar mensagens do WebSocket
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'initial_data':
                case 'dashboard_update':
                    updateDashboard(data.data);
                    break;
                case 'access_denied':
                    showAccessDeniedModal(data.data);
                    break;
                case 'violation_detected':
                    showViolationNotification(data.data);
                    break;
                case 'pong':
                    // Resposta do ping
                    break;
            }
        }

        // Atualizar dashboard
        function updateDashboard(data) {
            if (!data || data.error) {
                showError('Erro ao carregar dados: ' + (data?.error || 'Erro desconhecido'));
                return;
            }

            dashboardData = data;
            updateStats(data.statistics);
            updateBlockedEmployees(data.blocked_employees);
            updateActiveEmployees(data.active_sessions);
            lastUpdateTime = new Date();
        }

        // Atualizar estat√≠sticas
        function updateStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <span class="stat-icon">üë•</span>
                    <div class="stat-value">${stats.total_employees}</div>
                    <div class="stat-label">Total de Funcion√°rios</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">‚úÖ</span>
                    <div class="stat-value">${stats.active_sessions}</div>
                    <div class="stat-label">Sess√µes Ativas</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üö´</span>
                    <div class="stat-value">${stats.blocked_employees}</div>
                    <div class="stat-label">Funcion√°rios Bloqueados</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üîÑ</span>
                    <div class="stat-value">${stats.active_cycles}</div>
                    <div class="stat-label">Ciclos Ativos</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üì±</span>
                    <div class="stat-value">${stats.connected_devices}/${stats.total_devices}</div>
                    <div class="stat-label">Dispositivos Conectados</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">‚ö†Ô∏è</span>
                    <div class="stat-value">${stats.critical_violations}</div>
                    <div class="stat-label">Viola√ß√µes Cr√≠ticas</div>
                </div>
            `;
        }

        // Atualizar funcion√°rios bloqueados
        function updateBlockedEmployees(blockedEmployees) {
            const container = document.getElementById('blockedEmployees');
            
            if (!blockedEmployees || blockedEmployees.length === 0) {
                container.innerHTML = '<div class="loading">Nenhum funcion√°rio bloqueado</div>';
                return;
            }

            container.innerHTML = blockedEmployees.map(employee => `
                <div class="employee-card" onclick="showEmployeeDetails(${employee.employee_id})">
                    <div class="employee-name">${employee.employee_name}</div>
                    <div class="employee-id">ID: ${employee.employee_id}</div>
                    <div class="employee-time">
                        <div>Bloqueado: ${employee.block_start}</div>
                        <div>Retorna: ${employee.return_time}</div>
                        <div>Tempo restante: ${employee.time_remaining?.formatted || 'N/A'}</div>
                    </div>
                    <div class="employee-status status-blocked">BLOQUEADO</div>
                </div>
            `).join('');
        }

        // Atualizar funcion√°rios ativos
        function updateActiveEmployees(activeEmployees) {
            const container = document.getElementById('activeEmployees');
            
            if (!activeEmployees || activeEmployees.length === 0) {
                container.innerHTML = '<div class="loading">Nenhum funcion√°rio ativo</div>';
                return;
            }

            container.innerHTML = activeEmployees.map(employee => {
                // Calcular tempo decorrido usando tempo_decorrido_minutos da API
                const elapsedMinutes = employee.tempo_decorrido_minutos || 0;
                const elapsedHours = Math.floor(elapsedMinutes / 60);
                const remainingMinutes = elapsedMinutes % 60;
                
                return `
                    <div class="employee-card active" onclick="showEmployeeDetails(${employee.employee_id})">
                        <div class="employee-name">${employee.employee_name || 'Nome n√£o dispon√≠vel'}</div>
                        <div class="employee-id">ID: ${employee.employee_id || 'N/A'}</div>
                        <div class="employee-time">
                            <div><strong>Iniciado em:</strong> ${formatTimestamp(employee.first_access)}</div>
                            <div><strong>√öltimo acesso:</strong> ${formatTimestamp(employee.last_access)}</div>
                            <div><strong>Tempo decorrido:</strong> ${elapsedHours}h ${remainingMinutes}min</div>
                        </div>
                        <div class="employee-status status-active">${(employee.state || 'UNKNOWN').toUpperCase()}</div>
                    </div>
                `;
            }).join('');
        }

        // Mostrar modal de acesso negado
        function showAccessDeniedModal(data) {
            const modal = document.getElementById('accessDeniedModal');
            const modalInfo = document.getElementById('modalEmployeeInfo');
            
            modalInfo.innerHTML = `
                <div class="modal-employee-name">${data.employee_name}</div>
                <div class="modal-employee-id">ID: ${data.employee_id}</div>
                <div class="modal-time-info">Hor√°rio de retorno: ${data.return_time}</div>
                <div class="modal-time-info">Tempo restante: ${data.time_remaining?.formatted || 'N/A'}</div>
            `;
            
            modal.style.display = 'block';
            
            // Tocar som de alerta
            if (audioEnabled) {
                playAlertSound();
            }
            
            // Auto-fechar ap√≥s 8 segundos
            setTimeout(() => {
                closeModal();
            }, 8000);
        }

        // Fechar modal
        function closeModal() {
            const modal = document.getElementById('accessDeniedModal');
            modal.style.display = 'none';
        }
        
        // Fechar modal de detalhes do funcion√°rio
        function closeEmployeeModal() {
            const modal = document.getElementById('employeeDetailsModal');
            modal.style.display = 'none';
            
            // Limpar o timer
            if (modal.timerInterval) {
                clearInterval(modal.timerInterval);
                modal.timerInterval = null;
            }
        }

        // Mostrar notifica√ß√£o de viola√ß√£o
        function showViolationNotification(data) {
            // Implementar notifica√ß√£o de viola√ß√£o
            console.log('Viola√ß√£o detectada:', data);
        }

        // Mostrar detalhes do funcion√°rio
        function showEmployeeDetails(employeeId) {
            // Buscar dados do funcion√°rio
            const employee = dashboardData?.active_sessions?.find(emp => emp.employee_id == employeeId);
            
            if (!employee) {
                console.error('Funcion√°rio n√£o encontrado:', employeeId);
                return;
            }
            
            const modal = document.getElementById('employeeDetailsModal');
            const modalInfo = document.getElementById('employeeDetailsInfo');
            
            // Calcular tempo decorrido usando dados da API
            const elapsedMinutes = employee.tempo_decorrido_minutos || 0;
            const elapsedHours = Math.floor(elapsedMinutes / 60);
            const remainingMinutes = elapsedMinutes % 60;
            const elapsedSeconds = 0; // N√£o temos segundos na API
            
            modalInfo.innerHTML = `
                <div class="modal-employee-name">${employee.employee_name}</div>
                <div class="modal-employee-id">ID: ${employee.employee_id}</div>
                <div class="modal-time-info">
                    <strong>Estado:</strong> ${employee.state.toUpperCase()}
                </div>
                <div class="modal-time-info">
                    <strong>Iniciado em:</strong> ${formatTimestamp(employee.first_access)}
                </div>
                <div class="modal-time-info">
                    <strong>√öltimo acesso:</strong> ${formatTimestamp(employee.last_access)}
                </div>
                <div class="modal-time-info">
                    <strong>Tempo decorrido:</strong> 
                    <span id="elapsedTime">${elapsedHours}h ${remainingMinutes}min</span>
                </div>
                <div class="modal-time-info">
                    <strong>Pode sair em:</strong> 
                    <span id="timeRemaining">${employee.tempo_restante_interjornada ? employee.tempo_restante_interjornada + 'min' : 'Pode sair agora'}</span>
                </div>
            `;
            
            modal.style.display = 'block';
            
            // Os dados j√° est√£o corretos da API, n√£o precisamos de timer
            // O tempo ser√° atualizado quando o dashboard for atualizado
        }
        
        // Fechar modal de detalhes do funcion√°rio
        function closeEmployeeModal() {
            const modal = document.getElementById('employeeDetailsModal');
            modal.style.display = 'none';
        }

        // Tocar som de alerta
        function playAlertSound() {
            const audio = document.getElementById('alertAudio');
            audio.currentTime = 0;
            audio.play().catch(e => console.log('Erro ao tocar √°udio:', e));
        }

        // Alternar √°udio
        function toggleAudio() {
            audioEnabled = !audioEnabled;
            const audioBtn = document.getElementById('audioBtn');
            audioBtn.textContent = audioEnabled ? 'üîä √Åudio' : 'üîá Mudo';
            audioBtn.className = `audio-btn ${audioEnabled ? '' : 'muted'}`;
        }

        // Atualizar dados manualmente
        function refreshData() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                // Usar WebSocket que pega dados diretos do banco
                websocket.send(JSON.stringify({type: 'request_update'}));
            } else {
                // Fallback para requisi√ß√£o HTTP - usar a mesma API que funciona
                fetch('/admin/sessions/api/sessoes-ativas/')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Converter dados para o formato esperado pelo dashboard
                            const dashboardData = {
                                statistics: {
                                    total_employees: 0,
                                    active_sessions: data.sessoes.length,
                                    blocked_employees: data.sessoes.filter(s => s.state === 'blocked').length,
                                    active_cycles: 0,
                                    total_devices: 1,
                                    connected_devices: 1,
                                    unresolved_violations: 0,
                                    critical_violations: 0
                                },
                                blocked_employees: data.sessoes.filter(s => s.state === 'blocked'),
                                active_sessions: data.sessoes.filter(s => s.state === 'active' || s.state === 'pending_rest'),
                                recent_activities: {
                                    sessions: data.sessoes.slice(0, 10).map(s => ({
                                        employee_name: s.employee_name,
                                        state: s.get_state_display || s.state,
                                        updated_at: s.display_created_at || s.created_at
                                    })),
                                    violations: []
                                }
                            };
                            updateDashboard(dashboardData);
                        } else {
                            showError('Erro ao atualizar dados: ' + data.error);
                        }
                    })
                    .catch(error => {
                        showError('Erro ao atualizar dados: ' + error.message);
                    });
            }
        }

        // Mostrar erro
        function showError(message) {
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            container.insertBefore(errorDiv, container.firstChild);
            
            // Remover erro ap√≥s 5 segundos
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // Fechar modal com ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
                closeEmployeeModal();
            }
        });

        // Fechar modal clicando fora
        window.addEventListener('click', function(event) {
            const accessDeniedModal = document.getElementById('accessDeniedModal');
            const employeeDetailsModal = document.getElementById('employeeDetailsModal');
            
            if (event.target === accessDeniedModal) {
                closeModal();
            }
            if (event.target === employeeDetailsModal) {
                closeEmployeeModal();
            }
        });

        // Fun√ß√£o para formatar timestamp (igual ao dashboard de sess√µes)
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';

            // Se j√° est√° no formato de tempo (HH:MM:SS), retornar diretamente
            if (timestamp.includes(':') && !timestamp.includes('/')) {
                return timestamp;
            }

            // Se est√° no formato brasileiro "11/10/2025 14:28:51", extrair apenas o tempo
            if (timestamp.includes('/') && timestamp.includes(' ')) {
                const timePart = timestamp.split(' ')[1];
                return timePart;
            }

            // Se est√° no formato ISO "2025-10-10T02:07:52", extrair apenas o tempo
            if (timestamp.includes('T')) {
                const timePart = timestamp.split('T')[1];
                return timePart;
            }

            return timestamp;
        }

        // Atualizar contadores de tempo em tempo real
        function updateTimeCounters() {
            const activeEmployees = document.querySelectorAll('#activeEmployees .employee-card');
            
            activeEmployees.forEach(card => {
                const timeElements = card.querySelectorAll('.employee-time div');
                if (timeElements.length >= 3) {
                    const firstAccessText = timeElements[0].textContent;
                    const timeDecorridoElement = timeElements[2];
                    
                    // Extrair hor√°rio do primeiro acesso
                    const timeMatch = firstAccessText.match(/(\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}:\d{2})/);
                    if (timeMatch) {
                        const firstAccessTime = new Date(timeMatch[1]);
                        const now = new Date();
                        const elapsedMs = now - firstAccessTime;
                        const elapsedHours = Math.floor(elapsedMs / (1000 * 60 * 60));
                        const elapsedMinutes = Math.floor((elapsedMs % (1000 * 60 * 60)) / (1000 * 60));
                        const elapsedSeconds = Math.floor((elapsedMs % (1000 * 60)) / 1000);
                        
                        timeDecorridoElement.innerHTML = `<strong>Tempo decorrido:</strong> ${elapsedHours}h ${elapsedMinutes}min ${elapsedSeconds}s`;
                    }
                }
            });
        }

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            // Carregar dados iniciais via HTTP (mais confi√°vel)
            refreshData();
            
            // Tentar conectar WebSocket
            initWebSocket();
            
            // Ping peri√≥dico para manter conex√£o
            setInterval(() => {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({type: 'ping'}));
                }
            }, 30000);
            
            // Atualizar dados a cada 5 segundos via HTTP
            setInterval(refreshData, 5000);
            
            // Atualizar contadores de tempo a cada segundo
            setInterval(updateTimeCounters, 1000);
        });
    </script>
</body>
</html>
