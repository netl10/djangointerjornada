{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<style>
    /* Reset e base */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f8f9fa;
        color: #212529;
        line-height: 1.6;
    }

    #content-main {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Header */
    .header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header h1 {
        color: #2c3e50;
        font-size: 2.2em;
        margin-bottom: 8px;
        font-weight: 600;
    }

    .header p {
        color: #6c757d;
        font-size: 1.1em;
    }

    /* Controles */
    .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .status-info {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .status-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.95em;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #28a745;
        animation: pulse 2s infinite;
    }

    .status-dot.offline {
        background: #dc3545;
        animation: none;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .auto-refresh {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .switch {
        position: relative;
        width: 44px;
        height: 24px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .3s;
        border-radius: 24px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .3s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: #28a745;
    }

    input:checked + .slider:before {
        transform: translateX(20px);
    }

    /* Grid de sess√µes */
    .sessions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 16px;
    }

    /* Card de sess√£o */
    .session-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .session-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .session-card.active {
        border-left-color: #28a745;
    }

    .session-card.pending-rest {
        border-left-color: #ffc107;
    }

    .session-card.blocked {
        border-left-color: #dc3545;
    }

    /* Header do card */
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .employee-info h3 {
        font-size: 1.2em;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 4px;
    }

    .employee-id {
        font-size: 0.85em;
        color: #6c757d;
        background: #f8f9fa;
        padding: 2px 8px;
        border-radius: 4px;
        display: inline-block;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-badge.active {
        background: #d4edda;
        color: #155724;
    }

    .status-badge.pending-rest {
        background: #fff3cd;
        color: #856404;
    }

    .status-badge.blocked {
        background: #f8d7da;
        color: #721c24;
    }

    /* Conte√∫do do card */
    .card-content {
        font-size: 0.9em;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .info-label {
        color: #6c757d;
        font-weight: 500;
    }

    .info-value {
        color: #2c3e50;
        font-weight: 600;
    }

    .time-info {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        margin-top: 12px;
        border: 1px solid #e9ecef;
    }

    .time-highlight {
        color: #dc3545;
        font-weight: 700;
    }

    /* Estado vazio */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .empty-state-icon {
        font-size: 3em;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .empty-state h3 {
        font-size: 1.3em;
        margin-bottom: 8px;
        color: #495057;
    }

    .empty-state p {
        font-size: 1em;
        opacity: 0.8;
    }

    /* Responsividade */
    @media (max-width: 768px) {
        .sessions-grid {
            grid-template-columns: 1fr;
        }
        
        .controls {
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }
        
        .status-info {
            justify-content: center;
        }
        
        .header h1 {
            font-size: 1.8em;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <!-- Header -->
    <div class="header">
        <h1>üìä Sess√µes Ativas</h1>
        <p>Monitoramento de funcion√°rios em trabalho e interjornada</p>
    </div>
    
    <!-- Controles -->
    <div class="controls">
        <div class="status-info">
            <div class="status-item">
                <span id="monitor-status-dot" class="status-dot"></span>
                <span id="monitor-status-text">Monitor Online</span>
            </div>
            <div class="status-item">
                <span id="total-sessions">0</span>
                <span>Sess√µes Ativas</span>
            </div>
        </div>
        
        <div class="auto-refresh">
            <label for="autoRefreshToggle">Auto-refresh:</label>
            <label class="switch">
                <input type="checkbox" id="autoRefreshToggle" checked>
                <span class="slider"></span>
            </label>
        </div>
    </div>
    
    <!-- Container das sess√µes -->
    <div id="sessions-container">
        <div class="empty-state" id="empty-state">
            <div class="empty-state-icon">üë•</div>
            <h3>Nenhuma sess√£o ativa</h3>
            <p>As sess√µes aparecer√£o aqui quando funcion√°rios passarem na catraca</p>
        </div>
        
        <div class="sessions-grid" id="sessions-grid" style="display: none;">
            <!-- Cards de sess√£o ser√£o inseridos aqui -->
        </div>
    </div>
</div>

<script>
    let autoRefreshEnabled = true;
    let refreshInterval = 3000; // 3 segundos
    let lastSessionsData = [];

    // Formatar tempo
    function formatTime(minutes) {
        if (minutes < 60) {
            return `${minutes}min`;
        } else {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}min`;
        }
    }

    // Formatar timestamp
    function formatTimestamp(timestamp) {
        if (!timestamp) return 'N/A';
        
        // Extrair apenas o tempo (HH:MM:SS)
        if (timestamp.includes(' ')) {
            return timestamp.split(' ')[1];
        }
        if (timestamp.includes('T')) {
            return timestamp.split('T')[1].substring(0, 8);
        }
        return timestamp;
    }

    // Obter classe CSS do estado
    function getStateClass(state) {
        switch(state) {
            case 'active': return 'active';
            case 'pending_rest': return 'pending-rest';
            case 'blocked': return 'blocked';
            default: return 'active';
        }
    }

    // Obter texto do estado
    function getStateText(state) {
        switch(state) {
            case 'active': return 'Trabalhando';
            case 'pending_rest': return 'Aguardando Sa√≠da';
            case 'blocked': return 'Interjornada';
            default: return 'Ativo';
        }
    }

    // Criar card de sess√£o
    function createSessionCard(session) {
        const stateClass = getStateClass(session.state);
        const stateText = getStateText(session.state);
        
        let timeInfo = '';
        
        if (session.state === 'active') {
            if (session.tempo_restante_interjornada !== null) {
                timeInfo = `
                    <div class="time-info">
                        <div class="info-row">
                            <span class="info-label">Tempo decorrido:</span>
                            <span class="info-value">${formatTime(session.tempo_decorrido_minutos)}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Pode sair em:</span>
                            <span class="info-value time-highlight">${formatTime(session.tempo_restante_interjornada)}</span>
                        </div>
                    </div>
                `;
            } else {
                timeInfo = `
                    <div class="time-info">
                        <div class="info-row">
                            <span class="info-label">Tempo decorrido:</span>
                            <span class="info-value">${formatTime(session.tempo_decorrido_minutos)}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Status:</span>
                            <span class="info-value time-highlight">Pode sair!</span>
                        </div>
                    </div>
                `;
            }
        } else if (session.state === 'blocked') {
            timeInfo = `
                <div class="time-info">
                    <div class="info-row">
                        <span class="info-label">Bloqueado desde:</span>
                        <span class="info-value">${formatTimestamp(session.block_start)}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Libera em:</span>
                        <span class="info-value time-highlight">${formatTime(session.tempo_restante_liberacao)}</span>
                    </div>
                </div>
            `;
        }

        return `
            <div class="session-card ${stateClass}" data-session-id="${session.id}">
                <div class="card-header">
                    <div class="employee-info">
                        <h3>${session.employee_name}</h3>
                        <span class="employee-id">ID: ${session.employee_id}</span>
                    </div>
                    <span class="status-badge ${stateClass}">${stateText}</span>
                </div>
                
                <div class="card-content">
                    <div class="info-row">
                        <span class="info-label">Iniciado em:</span>
                        <span class="info-value">${formatTimestamp(session.first_access)}</span>
                    </div>
                    ${session.last_access ? `
                        <div class="info-row">
                            <span class="info-label">√öltimo acesso:</span>
                            <span class="info-value">${formatTimestamp(session.last_access)}</span>
                        </div>
                    ` : ''}
                    ${timeInfo}
                </div>
            </div>
        `;
    }

    // Buscar sess√µes
    async function fetchSessions() {
        if (!autoRefreshEnabled) return;

        try {
            const response = await fetch('/admin/sessions/api/sessoes-ativas/');
            const data = await response.json();

            if (data.success) {
                // Atualizar contador
                document.getElementById('total-sessions').textContent = data.total_sessoes;

                // Verificar mudan√ßas
                const currentIds = data.sessoes.map(s => s.id).sort();
                const lastIds = lastSessionsData.map(s => s.id).sort();
                const hasChanges = JSON.stringify(currentIds) !== JSON.stringify(lastIds);
                
                if (hasChanges || data.sessoes.length === 0) {
                    updateSessionsDisplay(data.sessoes);
                    lastSessionsData = data.sessoes;
                }

                updateMonitorStatus(true);
            } else {
                console.error('Erro na API:', data.error);
                updateMonitorStatus(false);
            }
        } catch (error) {
            console.error('Erro ao buscar sess√µes:', error);
            updateMonitorStatus(false);
        }
    }

    // Atualizar exibi√ß√£o
    function updateSessionsDisplay(sessions) {
        const container = document.getElementById('sessions-container');
        const emptyState = document.getElementById('empty-state');
        const grid = document.getElementById('sessions-grid');

        if (sessions.length === 0) {
            emptyState.style.display = 'block';
            grid.style.display = 'none';
        } else {
            emptyState.style.display = 'none';
            grid.style.display = 'grid';
            
            grid.innerHTML = '';
            sessions.forEach(session => {
                const cardHtml = createSessionCard(session);
                grid.insertAdjacentHTML('beforeend', cardHtml);
            });
        }
    }

    // Atualizar status do monitor
    function updateMonitorStatus(isOnline) {
        const statusText = document.getElementById('monitor-status-text');
        const statusDot = document.getElementById('monitor-status-dot');
        
        if (isOnline) {
            statusText.textContent = 'Monitor Online';
            statusDot.className = 'status-dot';
        } else {
            statusText.textContent = 'Monitor Offline';
            statusDot.className = 'status-dot offline';
        }
    }

    // Event listeners
    document.getElementById('autoRefreshToggle').addEventListener('change', function() {
        autoRefreshEnabled = this.checked;
        if (autoRefreshEnabled) {
            fetchSessions();
        }
    });

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
        fetchSessions();
        setInterval(fetchSessions, refreshInterval);
    });
</script>
{% endblock %}
